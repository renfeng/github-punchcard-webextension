<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

	<title>Github Punchcard</title>
	<meta name="description" content="Github Punchcard">

	<!-- See https://goo.gl/OOhYW5 -->
	<link rel="manifest" href="manifest.json">

	<!-- See https://goo.gl/qRE0vM -->
	<meta name="theme-color" content="#3f51b5">

	<!-- Add to homescreen for Chrome on Android. Fallback for manifest.json -->
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="application-name" content="Github Punchcard">

	<!-- Add to homescreen for Safari on iOS -->
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="Github Punchcard">

	<!-- Load webcomponents-loader.js to check and load any polyfills your browser needs -->
	<!-- webcomponents-loader.js doesn't work with vulcanize -->
	<!--<script src="components/webcomponentsjs/webcomponents-loader.js"></script>-->
	<!-- https://github.com/webcomponents/webcomponentsjs#how-to-use -->
	<script src="components/webcomponentsjs/webcomponents-lite.js"></script>

	<!-- Load your application shell -->
	<link rel="import" href="components/app-route/app-location.html"/>
	<link rel="import" href="components/app-route/app-route.html"/>
	<link rel="import" href="components/github-punchcard/github-punchcard.html">
	<link rel="import" href="components/paper-input/paper-input.html"/>
	<link rel="import" href="components/paper-toast/paper-toast.html"/>
	<link rel="import" href="components/polymer/lib/elements/dom-bind.html">

</head>
<body>
	<!-- https://www.polymer-project.org/2.0/docs/devguide/templates#dom-bind -->
	<dom-bind>
		<template>
			<app-location route="{{route}}" use-hash-as-path></app-location>
			<app-route route="{{route}}" pattern=":user/:repo" data="{{routeData}}" tail="{{routeTail}}"></app-route>

			<paper-input label="User" value="{{routeData.user}}"></paper-input>
			<paper-input label="Repo" value="{{routeData.repo}}"></paper-input>
			<github-punchcard id="punchcard" user="{{routeData.user}}" repo="{{routeData.repo}}"></github-punchcard>
			<paper-toast id="toast" duration="Infinity"></paper-toast>
		</template>
	</dom-bind>
	<script>
		var scope = document.querySelector("dom-bind");

		/*
		 * https://stackoverflow.com/questions/5039875/debug-popup-html-of-a-chrome-extension
		 * https://stackoverflow.com/questions/13359421/chrome-extension-get-current-tab-from-popup
		 */
		//chrome.tabs.getCurrent(function(tab){
		chrome.tabs.query({ active: true, currentWindow: true }, function(tabs){
			var tab = tabs[0];
			console.log("popup");
			console.log(tab);
			var urlPattern1 = new RegExp("^https://github.com/([^/]+)/([^/#]+)");
			var g = tab.url.match(urlPattern1);
			if (g) {
				scope.setProperties({
					"routeData.user": g[1],
					"routeData.repo": g[2],
				});
			} else {
				scope.setProperties({
					"routeData.user": "renfeng",
					"routeData.repo": "github-punchcard-webextension",
				});
			}
		});

		scope.$.punchcard.addEventListener("message", function (e) {
			if (e.detail) {
				scope.$.toast.text = e.detail.text;
				scope.$.toast.open();
			} else {
				scope.$.toast.close();
			}
		});
	</script>
</body>
</html>
